---
title: "Análise de imagem no Rstudio"
author: "Ana, João, Laura, Leonardo e Paulo"
date: "20 de novembro de 2019"
output: 
  beamer_presentation:
    keep_tex: true
    includes:
     in_header: Estilo.txt
    theme: "metropolis"
    latex_engine: xelatex
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

# Formatos de imagens
\small

\begin{itemize}
	\item TIFF
	\item BMP
	\item JPEG
	\item PNG
	\item SVG
	\item GIF
	\item PDF
	\item EPS
\end{itemize}

# A importância de análise de imagens
\small


# Como os pacotes lêem as imagens?
\small


# Pacotes
\small
Oos principais pacotes para manipulação de imagem são:

```{r 1, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}

require("BiocManager") 
require("EBImage") # JPEG(JPG), PNG E TIFF

require("imager") # JPEG(JPG), PNG E BMP

require("magick") 

```

# Importação e vizualização de imagens:
\small

- EBImage:

.ima <- readImage("C:/Users/nick_/Downloads/897207.jpg")
.display(ima)

- Imager: 

.ima_1 <- load.image("C:/Users/nick_/Downloads/897207.jpg")
.plot(ima_1)

- Magick: 

.ima_2 <- image_read("C:/Users/nick_/Downloads/897207.jpg")
.print(ima_2)


# Mudar dimensões
\small

```{r 2, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}

tigre <- image_read_svg('http://jeroen.github.io/images/tiger.svg')
tigre

```

# Mudar dimensões
\small

```{r 2.1, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}

tigre2 <- image_read_svg('http://jeroen.github.io/images/tiger.svg',
                         width = 120) # 120 = width, 120x = height
tigre2

tigre_redimensionada <- image_scale(tigre, "120x120")

```

# Converter ou salvar em formatos desejados
\small

```{r 3, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}

tigre_convertido <- image_convert(tigre, "jpeg")
image_info(tigre_convertido) # Retorna o formato da imagem

image_write(tigre, path = "tiger.png", format = "png")

```

# Imagens para manipulação (Frink)

```{r 5, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}
frink <- image_read("C:/Users/nick_/OneDrive/Área de Trabalho/image_analysis/Slide/IMAGENS/frink.png")
frink
```

# Imagens para manipulação (BigData)

```{r 5.1.1, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}
bigdata <- image_read('C:/Users/nick_/OneDrive/Área de Trabalho/image_analysis/Slide/IMAGENS/bigdata.jpg')
bigdata
```

# Imagens para manipulação (R)

```{r 5.1.2, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}
logo <- image_read('C:/Users/nick_/OneDrive/Área de Trabalho/image_analysis/Slide/IMAGENS/Rlogo.png')
logo
```

# Girar e modificar
\small

\includegraphics[width=3.7in]{IMAGENS/girar_modificar}
\begin{center}
\tiny{Fonte: https://cran.r-project.org/web/packages/magick/vignettes/intro.html}
\end{center}

# Alguns tipos de filtros
\small

\includegraphics[width=4.4in]{IMAGENS/filtros}
\begin{center}
\tiny{Fonte: https://cran.r-project.org/web/packages/magick/vignettes/intro.html}
\end{center}

# Imagens sobrepostas
\small

```{r 5.2, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}
img <- c(bigdata, logo, frink)
img <- image_scale(img, "300x300")
image_info(img)
```
# Imagens sobrepostas

\small

\includegraphics[width=4.4in]{IMAGENS/juntar_sobrepor}
\begin{center}
\tiny{Fonte: https://cran.r-project.org/web/packages/magick/vignettes/intro.html}
\end{center}

# Imagens sobrepostas

```{r 5.3, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}

bigdatafrink <- image_scale(image_rotate(
  image_background(frink, "none"), 300), "x160")
juntos <-image_composite(image_scale(
  bigdata, "x330"), bigdatafrink, offset = "+180+100")

```

# Imagens sobrepostas

```{r 5.4, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
juntos
```

# Utilidade em gráficos
\small

```{r 5.5, message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}

require(readr)
Estat.subida <- read_csv("C:/Users/nick_/OneDrive/Área de Trabalho/Mount_Rainier_Shiny/Lista04/climbing_statistics.csv")
Clima <- read_csv("C:/Users/nick_/OneDrive/Área de Trabalho/Mount_Rainier_Shiny/Lista04/Rainier_Weather.csv")
library(dplyr)
BD <- inner_join(Estat.subida, Clima, by = "Date")
BD <- filter(BD, Attempted >= Succeeded)
BD$`Success Percentage` <- round(BD$`Success Percentage`*100)
require(ggplot2)
require(ggforce)
PSxTEMP <- ggplot(BD, aes(`Temperature AVG`, `Success Percentage`), size = `Wind Speed Daily AVG`)+
  theme_minimal() +
  theme(axis.title.x = element_text(size = 16),
        axis.text.x = element_text(size = 14),
        axis.text.y = element_text(size = 14),
        axis.title.y = element_text(size = 16),
        legend.text = element_text(size = 13),
        legend.title = element_text(size=14)) +
  labs(x = "Temperatura(Fº)",
       y = "Porcentagem de Sucesso",
       color = "Umidade média",
       size = "Velocidade média do vento")+
  geom_jitter( aes(color = `Relative Humidity AVG`, size = `Wind Speed Daily AVG`)) +
  geom_ellipse(aes(x0 = 11.5, y0 = 0, a = 5.4, b = 3, angle = 0), linetype = "dashed",
               colour = "darkred",size = 0.5) +
  scale_colour_gradient(low = "light blue", high = "dark blue")

```


```{r 5.6, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
PSxTEMP
```

# Utilidade para sobreposição de imagens

```{r 6, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}

graph <- image_read("C:/Users/nick_/OneDrive/Área de Trabalho/image_analysis/Slide/IMAGENS/Rplot1.png")
temp <- image_read("C:/Users/nick_/OneDrive/Área de Trabalho/image_analysis/Slide/IMAGENS/low_temp.png")
temp_graph <- image_scale(image_rotate(image_background(
  temp, "none"), 340), "x50")
temp_graph
juntos_2 <-image_composite(image_scale(
  graph, "x600"), temp_graph, offset = "+150+440")
image_write(juntos_2, path = "juntos2.pdf", format = "pdf")

```

# Utilidade para sobreposição de imagens

\includegraphics[width=4.4in]{juntos2}
\begin{center}
\tiny{}
\end{center}

# Anotações em imagens

```{r 7, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}
frink_anot <- image_annotate(frink, "Aqui", size = 25,
                             color = "red",
                             boxcolor = "black",
                             degrees = 30, 
                             location = "+150+310")

frink_anot <- image_scale(frink_anot, "x350")

image_write(frink_anot, path = "frink_anot.png", format = "png")
```

# Anotações em imagens

\includegraphics[width=4.0in]{frink_anot}
\begin{center}
\tiny{}
\end{center}

# Como retirar pontos de um gráfico sem seu código?

\includegraphics[width=4.4in]{IMAGENS/grafico_ponto}
\begin{center}
\tiny{}
\end{center}

# Como retirar pontos de um gráfico sem seu código?

```{r 8, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}
library(tidyverse)
im <- image_read("C:/Users/nick_/OneDrive/Área de Trabalho/image_analysis/Slide/IMAGENS/grafico_ponto.jpg")
im_proc <- im %>%
    image_channel("saturation")
image_write(im_proc, path = "IMAGENS/grafico_ponto1.png", format = "png")
```

# Como retirar pontos de um gráfico sem seu código?

\includegraphics[width=4.4in]{IMAGENS/grafico_ponto1}
\begin{center}
\tiny{}
\end{center}

# Como retirar pontos de um gráfico sem seu código?
\small
```{r 8.1, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}
im_proc2 <- im_proc %>%
    image_threshold("white", "30%")
image_write(im_proc2, path = "IMAGENS/grafico_ponto2.png",
            format = "png")
```

\includegraphics[width=3.6in]{IMAGENS/grafico_ponto2}
\begin{center}
\tiny{}
\end{center}

# Como retirar pontos de um gráfico sem seu código?
\small
```{r 8.2, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}
im_proc3 <- im_proc2 %>%
    image_negate()
image_write(im_proc3, path = "IMAGENS/grafico_ponto3.png",
            format = "png")
```

\includegraphics[width=3.6in]{IMAGENS/grafico_ponto3}
\begin{center}
\tiny{}
\end{center}

# Como retirar pontos de um gráfico sem seu código?
\small
```{r 8.3, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}
require(tidyverse)
dat <- image_data(im_proc3)[1,,] %>%
    as.data.frame() %>%
    mutate(Row = 1:nrow(.)) %>%
    select(Row, everything()) %>%
    mutate_all(as.character) %>%
    gather(key = Column, value = value, 2:ncol(.)) %>%
    mutate(Column = as.numeric(gsub("V", "", Column)),
           Row = as.numeric(Row),
           value = ifelse(value == "00", NA, 1)) %>%
    filter(!is.na(value))
```
 
# Como retirar pontos de um gráfico sem seu código?
\small
```{r 8.4, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}
require(ggplot2)
grafico_final <-ggplot(data = dat,
                       aes(x = Row,
                           y = Column,
                           colour = (Column < 200))) +
    geom_point() +
    scale_y_continuous(trans = "reverse") +
    scale_colour_manual(values = c( "blue4","red4")) +
    theme(legend.position = "off")+
  ggsave("grafico_final.pdf", width = 4, height = 4)
```

# Como retirar pontos de um gráfico sem seu código?
\small

\includegraphics[width=4.0in]{IMAGENS/grafico_final}
\begin{center}
\tiny{}
\end{center}

# Fraqueza na leitura de PDF

```{r 9, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}

require(pdftools)
tempo <- image_read_pdf("C:/Users/nick_/OneDrive/Área de Trabalho/image_analysis/Slide/IMAGENS/temp.pdf")
image_write(tempo, path = "tempo.pdf", format = "pdf")

```

# Fraqueza na leitura de PDF
\small

\includegraphics[width=4.0in]{tempo}
\begin{center}
\tiny{}
\end{center}

# Gifs

```{r 7.1, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}
earth <- image_read("https://jeroen.github.io/images/earth.gif") %>%
  image_scale("250x") %>% 
  image_quantize() 

length(earth) 
```

# Como montar um GIF

1º - Importe as imagens:

$\Rightarrow$ im_1 <- image_read("C:/Users/nick_/Downloads/im_1.jpg")

$\Rightarrow$ im_n <- image_read("C:/Users/nick_/Downloads/im_n.jpg")

2º - Junte as imagens e redimensione:

$\Rightarrow$ img <- c(im_1, ... , im_n)

$\Rightarrow$ img <- image_scale(img, "300x300")

3º - Argumentos:

$\Rightarrow$ image_animate(img)

# Salvar o GIF na máquina

```{r 7.2, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}
im_1 <- image_read("c:/Users/nick_/Downloads/im_1.jpg")
im_n <- image_read("c:/Users/nick_/Downloads/im_n.jpg")
img <- c(im_1, ... , im_n)
img <- image_scale(img, "300x300")
img <- image_animate(img)
```

```{r 7.3, eval=FALSE, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}

library(gifski)

image_write_gif(img, path = "grafico.gif")
 # É possivel adicionar um delay
image_write_gif(img, path = "grafico_delay.gif",
                delay = 1/6)

```

# ANA
\small
```{r 12, eval=FALSE, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}
# Download da imagem
file="http://ereaderbackgrounds.com/movies/bw/Frankenstein.jpg"
download.file(file, destfile = "frankenstein.jpg", mode = 'wb')
# Lê e converte para a escala de cinza
load.image("C:/Users/nick_/Downloads/Frankenstein.jpg") %>% 
  grayscale() -> x
```

# ANA
\small
```{r 12.1, eval=FALSE, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}
# Isso é apenas para definir os limites dos frames
x %>% 
  as.data.frame() %>% 
  group_by() %>% 
  summarize(xmin=min(x), xmax=max(x), ymin=min(y), ymax=max(y)) %>% 
  as.vector()->rw
```

# ANA
\small
```{r 12.2, eval=FALSE, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}
# Filtra a imagem e converte para preto e branco
x %>%
  threshold("45%") %>% 
  as.cimg() %>% 
  as.data.frame() -> df
```

# ANA
\small
```{r 12.3, eval=FALSE, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}
# Função para calcular e plotar o diagrama de Voronoi, depende
# do tamanho da amostra
doPlot = function(n)
{
  #V Diagrama de Voronoi
  df %>% 
    sample_n(n, weight=(1-value)) %>% 
    select(x,y) %>% 
    deldir(rw=rw, sort=TRUE) %>% 
    .$dirsgs -> data
```

# ANA
\small
```{r 12.4, eval=FALSE, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}
 # Isso é apenas para adicionar alguns alfas nas linhas, depende
# da longitude
  data %>% 
    mutate(long=sqrt((x1-x2)^2+(y1-y2)^2),
           alpha=findInterval(long,
                              quantile(long,
                                       probs = seq(0,
                                                   1,
                                                   length.out = 20)
                                       )
                              )/21)-> data
```

# ANA
\small
```{r 12.5, eval=FALSE, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}
data %>% 
    ggplot(aes(alpha=(1-alpha))) +
    geom_segment(aes(x = x1, y = y1, xend = x2, yend = y2),
                 color="black", lwd=1) +
    scale_x_continuous(expand=c(0,0))+
    scale_y_continuous(expand=c(0,0), trans=reverse_trans())+
    theme(legend.position  = "none",
          panel.background = element_rect(fill="white"),
          axis.ticks       = element_blank(),
          panel.grid       = element_blank(),
          axis.title       = element_blank(),
          axis.text        = element_blank())->plot
  return(plot)}
```

# ANA
\small

```{r 12.6, eval=FALSE, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}
# Eu chamei a função anterior e salvei o resultado do plot em
# formato jpeg
i= 500
name=paste0("frankie",i,".jpeg")
jpeg(name, width = 600, height = 800, units = "px",
     quality = 100)
doPlot(i)
dev.off()
```

# ANA
\small

```{r 12.7, eval=FALSE, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}
# Assim que todas as imagens são salvas, eu posso criar o GIF
library(magick)
frames=c()
images=list.files(pattern="jpeg")
for (i in length(images):1)
{
  x=image_read(images[i])
  x=image_scale(x, "300")
  c(x, frames) -> frames
}
animation=image_animate(frames, fps = 2)
image_write(animation, "Frankenstein.gif")
print(animation)
```

# Filtro geométrico
\small

\includegraphics[width=4.5in]{IMAGENS/Frida}
\begin{center}
\tiny{}
\end{center}

# Filtro geométrico
\small

Por meio do pacote "imager" é possível estilizar uma imagem e deixá-la pixelizada:

```{r 10, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}
library(imager)
foto <- load.image("C:/Users/nick_/Downloads/foto.jpg")

foto2<- foto %>%  resize(size_x = 80, size_y = 80,
                         interpolation_type = 1L)
suppressMessages(suppressWarnings(library(imager)))
foto2 <- rowMeans(foto2, dims = 2)
```

# Filtro geométrico
\small

```{r 10.1, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}
foto2 %>%
  apply(1, rev) %>% 
  t() %>% 
  image(col = grey.colors(256), axes = FALSE)
```

# Keras

\includegraphics[width=4.5in]{IMAGENS/Keras_logo}
\begin{center}
\tiny{}
\end{center}

# TensorFlow

\includegraphics[width=4.5in]{IMAGENS/TensorFlow_logo}
\begin{center}
\tiny{}
\end{center}

# Anaconda

\includegraphics[width=4.2in]{IMAGENS/Anaconda}
\begin{center}
\tiny{}
\end{center}

# Reconhecimento de imagem - Aviões e carros

\includegraphics[width=4.0in]{IMAGENS/Avioes_carros}
\begin{center}
\tiny{}
\end{center}

# Reconhecimento de imagem - Pacotes

```{r 11, eval=FALSE, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}
install.packages("tfestimators")
install_tensorflow()
devtools::install_github("rstudio/keras")
devtools::install_github("rstudio/tensorflow")
devtools::install_github("rstudio/keras")
reticulate::py_discover_config()
reticulate::use_condaenv("r-tensorflow")
reticulate::py_config()
```

# Reconhecimento de imagem - Leitura

```{r 11.1, eval=FALSE, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}
library(EBImage)
library(keras)
library(kerasR)
library(kerasformula)
setwd('C:\\Users\\Matheus\\Desktop\\Nova pasta\\diretorio R')
pics <- c('p1.jpg', 'p2.jpg', 'p3.jpg', 'p4.jpg', 'p5.jpg',
          'p6.jpg','c1.jpg', 'c2.jpg', 'c3.jpg', 'c4.jpg', 
          'c5.jpg','c6.jpg')
mypic <- list()
for (i in 1:12) {mypic[[i]] <- readImage(pics[i])}
```

# Reconhecimento de imagem - Análise manual

```{r 11.2, eval=FALSE, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}
print(mypic[[1]])
display(mypic[[12]])
summary(mypic[[1]])
hist(mypic[[2]])
```

# Reconhecimento de imagem - Redimensionamento

```{r 11.3, eval=FALSE, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}
for (i in 1:12) {mypic[[i]] <- resize(mypic[[i]],28, 28)}
for (i in 1:12) {mypic[[i]] <- array_reshape(mypic[[i]],
                                             c(28,28,3))}
```

# Reconhecimneto de imagem - Remodelagem

```{r 11.4, eval=FALSE, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}
trainx <- NULL
for (i in 1:5) {trainx <- rbind(trainx, mypic[[i]])}
for (i in 7:11) {trainx <- rbind(trainx, mypic[[i]])}
str(trainx)
testx <- rbind(mypic[[6]], mypic[[12]])
trainy <- c(0,0,0,0,0,1,1,1,1,1)
testy <- c(0, 1)
```

# Reconhecimneto de imagem - Criação de labels

```{r 11.5, eval=FALSE, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}
trainLabels <- to_categorical(trainy)
testLabels <- to_categorical(testy)
```

# Reconhecimento de imagem - Modelo

```{r 11.6, eval=FALSE, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}
model <- keras_model_sequential()
model %>%
         layer_dense(units = 256, activation = 'relu',
                     input_shape = c(2352)) %>%
         layer_dense(units = 128, activation = 'relu') %>%
         layer_dense(units = 2, activation = 'softmax')
summary(model)
```

# Reconhecimento de imagem - Compilação

```{r 11.7, eval=FALSE, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}
model %>%
         compile(loss = 'binary_crossentropy',
                 optimizer = optimizer_rmsprop(),
                 metrics = 'accuracy')
```

# Reconhecimento de imagem - Ajustando/ Treinando o modelo

```{r 11.8, eval=FALSE, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}
history <- model %>%
         fit(trainx,
             trainLabels,
             epochs = 500,
             batch_size = 32,
             validation_split = 0.2)
```

# Reconhecimento de imagem - Ajustando/ Treinando o modelo

\includegraphics[width=3.2in]{IMAGENS/modelo_grafico}
\begin{center}
\tiny{}
\end{center}

# Reconhecimento de imagem - Avaliação e previsão

```{r 11.9, eval=FALSE, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}
model %>% evaluate(testx, testLabels)
pred <- model %>% predict_classes(trainx)
table(Predicted = pred, Actual = trainy)
prob <- model %>% predict_proba(trainx)
cbind(prob, Prected = pred, Actual= trainy)
```